---
import ThemeToggle from "../ThemeToggle.astro";
// import Search from "../Search.astro";
import { getEntry, getCollection } from 'astro:content';
// import { siteConfig } from "@/site-config";
import GoBack from "@/components/GoBack.astro";
import { Icon } from "astro-icon/components";

// Add default values
let showHeader = true;
let showLogo = true;
let showTheme = true;
let showSwitch = true;
let showHome = true;
let logoImage = '';
let defaultView = 'grid';
let showCheck = false;
let backgroundImage = '';
let backgroundVideo = '';
let topText = 'Top';
let appName = 'Site Name';
// Get menu items and sort them
let sortedMenuLinks: Array<{title: string, path: string}> = [];
try {
  const menuItems = await getCollection('menuItems');
  if (menuItems) {
    sortedMenuLinks = menuItems
      .sort((a, b) => (a.data.order || 0) - (b.data.order || 0))
      .map(item => ({
        title: item.data.title || '',
        path: item.data.path || '/',
      }));
  }
} catch (error) {
  console.error('Error loading menu items:', error);
}

// Get PWA menu items and sort them
let sortedPwaMenuItems: Array<{friendlyName: string, link: string, icon: string, order: number}> = [];
try {
  const pwaMenuItems = await getCollection('pwaMenuItems');
  if (pwaMenuItems) {
    sortedPwaMenuItems = pwaMenuItems
      .sort((a, b) => {
        if (typeof a.data.order === 'number' && typeof b.data.order === 'number') {
          return a.data.order - b.data.order;
        }
        if (typeof a.data.order === 'number') return -1;
        if (typeof b.data.order === 'number') return 1;
        return a.id.localeCompare(b.id);
      })
      .map(item => ({
        friendlyName: item.data.friendlyName || '',
        link: item.data.link || '',
        icon: item.data.icon || '',
        order: item.data.order || 0,
      }));
  }
} catch (error) {
  console.error('Error loading PWA menu items:', error);
}

const siteSettings = await getEntry('siteSettings', 'main');
const pwaSettings = await getEntry('pwaSettings', 'index');

try {
  const language = await getEntry('language', 'index');
  const styleapps = await getEntry('styleapps', 'index');

  if (siteSettings?.data) {
    ({ 
      showHeader = true, 
      showLogo = true, 
      showTheme = true, 
      showSwitch = true, 
      showHome = true, 
      logoImage = '', 
      defaultView = 'grid', 
    } = siteSettings.data);
  }

  if (styleapps?.data) {
    backgroundImage = styleapps.data.backgroundImage ?? '';
    backgroundVideo = styleapps.data.backgroundVideo ?? '';
  }

  if (language?.data) {
    topText = language.data.top ?? 'Top';
  }

  if (pwaSettings?.data) {
    appName = pwaSettings.data.name ?? 'Site Name';
  }
} catch (error) {
  console.error('Error loading content:', error);
}

const url = new URL(Astro.request.url);

// Helper function to normalize paths for comparison
const normalizePath = (path: string) => {
  // Remove trailing slash unless it's the root
  return path === '/' ? '/' : path.replace(/\/$/, '');
};

const currentPath = normalizePath(url.pathname);

---


<style>

  @media all and (display-mode: browser) {
        .pwaonly {
          position:absolute;
          left:-9999px;
          visibility: hidden;
        }
    }
    
@media all and (display-mode: standalone) {
        .pwaonly {
          /* Display controlled by individual elements */
        }
    }

.pwa-button{display:flex; justify-content: center;}

/* PWA Menu Items - Fixed bottom left corner */
#pwa-menu-items {
  position: fixed;
  bottom: 80px;
  left: 10px;
  display: flex;
  flex-direction: column;
  gap: 8px;
  z-index: 99;
  pointer-events: auto;
}

@media all and (display-mode: browser) {
  #pwa-menu-items {
    display: none !important;
  }
}

#pwa-menu-items a {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 48px;
  height: 48px;
  background: var(--theme-header);
  border-radius: 8px;
  color: #fff;
  transition: all 0.2s;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
}

#pwa-menu-items a:hover {
  transform: scale(1.1);
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4);
}

#pwa-menu-items svg {
  width: 28px;
  height: 28px;
  color: #fff;
}

/* Custom links styling to match site links */
#pwa-custom-links {
  display: contents;
}

.pwa-custom-link,
.pwa-site-link {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 48px;
  height: 48px;
  background: var(--theme-header);
  border-radius: 8px;
  color: #fff;
  transition: all 0.2s;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
}

.pwa-custom-link:hover,
.pwa-site-link:hover {
  transform: scale(1.1);
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4);
}

.pwa-custom-link svg {
  width: 28px;
  height: 28px;
  color: #fff;
}

#bottom-menu-container {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  display: grid;
  place-items: center;
  pointer-events: none;
  z-index: 100;
  transition: all 0.3s ease;
}

#bottom-menu-container.top-left {
  top: 10px;
  bottom: auto;
  left: 10px;
  right: auto;
  place-items: start;
}

#bottom-menu-container.top-center {
  top: 10px;
  bottom: auto;
  place-items: center;
}

#bottom-menu-container.top-right {
  top: 10px;
  bottom: auto;
  left: auto;
  right: 10px;
  place-items: end;
}

#bottom-menu-container.bottom-left {
  left: 10px;
  right: auto;
  place-items: start;
}

#bottom-menu-container.bottom-center {
  /* Default - already set */
}

#bottom-menu-container.bottom-right {
  left: auto;
  right: 10px;
  place-items: end;
}

  #bottom-menu-btn {
    pointer-events: auto;
    /* margin-bottom: 10px; */
    color: #fff;
  }

  #bottom-menu-btn svg {
    color: #fff;
    stroke: #fff;
  }
  
  #menu-popup {
  position: fixed;
  bottom: 60px;
  left: 50%;
  transform: translateX(-50%);
  background: var(--theme-header);
  color: #fff;
  border-radius: 8px;
  padding: .5rem;
  z-index: 100;
  display: none;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
  width:60%;
  max-width: 350px;
}

#menu-popup.show {
  display: block;
}

#menu-popup ul {
  list-style: none;
  margin: 0;
  padding: 0;
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}

#menu-popup a {
  padding: 1rem .5rem;
  display: block;
  text-align: center;
  transition: background 0.2s;
  color: #fff;
  border-bottom:1px dotted rgba(255, 255, 255, 0.4);
}

#menu-popup li:last-child a {
  border-bottom:none;
}

#menu-popup a:hover {
  background: rgba(255, 255, 255, 0.1);
}

#menu-popup a[aria-current="page"],
.topmenu a[aria-current="page"] {
  background: rgba(255, 255, 255, 0.2);
  pointer-events: none;
  opacity: 0.7;
  cursor: default;
}

.topmenu a[aria-current="page"]:hover {
  text-decoration: none;
}
</style>


{showHeader && (
  <div id="menu" class="menu header" style="min-height:60px; padding: 2px 0 2px 0;">
    {showLogo && (
      <a href="/" aria-current={currentPath === "/" ? "page" : undefined} class="relative px-1">
        {siteSettings?.data?.logoImage ? (
          <img 
            src={siteSettings.data.logoImage}
            alt="Site Logo"
            class="headerlogo"
            loading="eager"
            fetchpriority="high"
            width="auto"
            height="auto"
            style="max-height:60px; min-width: 50px;"
          />
        ) : (
          <span class="text-lg font-bold logotext" style="margin-left:10px;">{appName}</span>
        )}
      </a>
    )}

    <ul class="topmenu flex justify-around items-center gap-4 m-auto p-0 h-15 text-center text-[clamp(0.6rem,1.6vw,1.8rem)]">
      {sortedMenuLinks.map((link: { path: string; title: string }) => (
        <li>
          <a
            href={link.path}
            class="px-4 py-4 sm:py-0 sm:hover:underline"
            aria-current={currentPath === normalizePath(link.path) ? "page" : undefined}
            rel="prefetch"
            data-astro-reload
          >
            {link.title}
          </a>
        </li>
      ))}
    </ul>

    
  </div>
  
)}



<!-- PWA Menu Items - Bottom left corner, toggles with menu -->
<!-- Combines user's custom links (top) with site's PWA links (bottom) -->
<div id="pwa-menu-items">
  <!-- Custom links loaded via JavaScript will be inserted here -->
  <div id="pwa-custom-links"></div>
  <!-- Site PWA menu items -->
  {sortedPwaMenuItems.map((item) => (
    <a
      href={item.link}
      target="_blank"
      rel="noopener noreferrer"
      aria-label={item.friendlyName}
      title={item.friendlyName}
      class="pwa-site-link"
    >
      <Icon name={item.icon} />
    </a>
  ))}
</div>




<div id="missioncontrol" class="missioncontrol1 sitecontrols flex items-center" style="padding:0 2vw 0 2vw; gap:1.5vw;">


  {showHome && (
    <button
    aria-label="Return to Home"
    name="Return to Home"
      class="flex h-10 w-10 items-center justify-center rounded-md ring-zinc-400 transition-all hover:ring-2"
      style="background: var(--theme-header);"
    ><a href="/" aria-current={currentPath === "/" ? "page" : undefined} name="Return to Home" aria-label="Return to Home">
    <svg aria-label="Return to Home" class="h-7 w-7" stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 576 512" height="28px" width="28px" xmlns="http://www.w3.org/2000/svg"><path d="M280.37 148.26L96 300.11V464a16 16 0 0 0 16 16l112.06-.29a16 16 0 0 0 15.92-16V368a16 16 0 0 1 16-16h64a16 16 0 0 1 16 16v95.64a16 16 0 0 0 16 16.05L464 480a16 16 0 0 0 16-16V300L295.67 148.26a12.19 12.19 0 0 0-15.3 0zM571.6 251.47L488 182.56V44.05a12 12 0 0 0-12-12h-56a12 12 0 0 0-12 12v72.61L318.47 43a48 48 0 0 0-61 0L4.34 251.47a12 12 0 0 0-1.6 16.9l25.5 31A12 12 0 0 0 45.15 301l235.22-193.74a12.19 12.19 0 0 1 15.3 0L530.9 301a12 12 0 0 0 16.9-1.6l25.5-31a12 12 0 0 0-1.7-16.93z"></path></svg></a></button>
    )}

  {showTheme && <ThemeToggle style="margin-left:1vw;" />}

  <!-- {showSearch && <Search />} -->

  

  <!-- Bottom centered menu button -->
  <!-- Always render, JavaScript will control visibility based on menu items + PWA links -->
  <div id="bottom-menu-container">
    <button
      id="bottom-menu-btn"
      aria-label="Toggle Menu"
      class="flex h-12 w-12 items-center justify-center rounded-full ring-zinc-400 transition-all hover:ring-2"
      style="background: var(--theme-header);"
    >
      <svg class="h-7 w-7" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" style="pointer-events: none;">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
      </svg>
    </button>
  </div>

  <!-- Menu popup -->
  <div id="menu-popup">
    {sortedMenuLinks.length > 0 && (
      <ul>
        {sortedMenuLinks.map((link: { path: string; title: string }) => (
          <li>
            <a 
              href={link.path} 
              rel="prefetch" 
              data-astro-reload
              aria-current={currentPath === normalizePath(link.path) ? "page" : undefined}
            >
              {link.title}
            </a>
          </li>
        ))}
      </ul>
    )}
  </div>





<GoBack />

<button
aria-label="Back to Top"
class="backup z-90 bottom-0 fixed end-2 flex h-10 w-10 translate-y-24 items-center justify-center rounded-md ring-zinc-400 hover:ring-2 opacity-0 transition-all duration-300 hover:border-zinc-400 data-[show=true]:translate-y-0 data-[show=true]:opacity-85 sm:end-2 sm:h-10 sm:w-10 topper"
data-show="false"
id="to-top-btn"
style="flex-direction: column;"
>
<svg  class="w-8 h-8" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="currentColor" d="M14 20h-4v-9l-3.5 3.5l-2.42-2.42L12 4.16l7.92 7.92l-2.42 2.42L14 11z"/></svg>
<span class="--theme-header" style="font-size:10px; font-weight: bold;">{topText}</span>
</button>

</div>



{backgroundImage && (
  <img class="backimage w-2.5 h-2.5" src={backgroundImage} alt="Default Background" width="10" height="10" />
  )}


{backgroundVideo && (
  <iframe
    src={backgroundVideo}
    title="video title"
    width="100%"
    height="800"
    frameborder="0"
    allowfullscreen
    class="vidbox"
    style="height:100vh !important;"
    loading="lazy"
></iframe>
)}


<script lang="ts">
  function initializeBackToTopButton() {
    const scrollBtn = document.getElementById("to-top-btn");
    const targetHeader = document.getElementById("top");

    if (!scrollBtn || !targetHeader) return;

    function callback(entries) {
      entries.forEach((entry) => {
        scrollBtn.dataset.show = (!entry.isIntersecting).toString();
      });
    }

    scrollBtn.addEventListener("click", () => {
      document.body.scrollTo({ top: 0, behavior: 'smooth' });
      document.documentElement.scrollTo({ top: 0, behavior: 'smooth' });
    });

    const observer = new IntersectionObserver(callback);
    observer.observe(targetHeader);
  }

  // Initialize on initial page load
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeBackToTopButton);
  } else {
    initializeBackToTopButton();
  }

  // Re-initialize after each page navigation
  document.addEventListener('astro:after-swap', initializeBackToTopButton);

  // Load and render custom PWA links from localStorage
  async function loadCustomPwaLinks() {
    try {
      const customLinks = JSON.parse(localStorage.getItem('customSocialLinks') || '[]');
      const container = document.getElementById('pwa-custom-links');
      
      console.log('Loading custom PWA links:', customLinks.length, 'links found');
      
      if (!container) {
        console.error('pwa-custom-links container not found');
        return;
      }
      
      if (customLinks.length === 0) {
        container.innerHTML = '';
        // Still call initializeBottomMenu to check for site PWA links
        setTimeout(() => {
          if (typeof initializeBottomMenu === 'function') {
            initializeBottomMenu();
          }
        }, 50);
        return;
      }
      
      // Helper function to generate initials
      function generateInitials(name) {
        if (!name) return '??';
        
        const words = name.trim().split(/\s+/);
        
        if (words.length >= 2) {
          // Two or more words: first letter of first two words
          return (words[0].charAt(0) + words[1].charAt(0)).toUpperCase();
        } else {
          // One word: first two letters
          return name.trim().substring(0, 2).toUpperCase();
        }
      }
      
      // Helper function to get SVG icon
      function getSvgIcon(iconName) {
        const icons = {
          'simple-icons:bluesky': '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 10.8c-1.087-2.114-4.046-6.053-6.798-7.995C2.566.944 1.561 1.266.902 1.565.139 1.908 0 3.08 0 3.768c0 .69.378 5.65.624 6.479.815 2.736 3.713 3.66 6.383 3.364.136-.02.275-.039.415-.056-.138.022-.276.04-.415.056-3.912.58-7.387 2.005-2.83 7.078 5.013 5.19 6.87-1.113 7.823-4.308.953 3.195 2.05 9.271 7.733 4.308 4.267-4.308 1.172-6.498-2.74-7.078a8.741 8.741 0 0 1-.415-.056c.14.017.279.036.415.056 2.67.297 5.568-.628 6.383-3.364.246-.828.624-5.79.624-6.478 0-.69-.139-1.861-.902-2.206-.659-.298-1.664-.62-4.3 1.24C16.046 4.748 13.087 8.687 12 10.8Z"/></svg>',
          'simple-icons:youtube': '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/></svg>',
          'simple-icons:tiktok': '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12.525.02c1.31-.02 2.61-.01 3.91-.02.08 1.53.63 3.09 1.75 4.17 1.12 1.11 2.7 1.62 4.24 1.79v4.03c-1.44-.05-2.89-.35-4.2-.97-.57-.26-1.1-.59-1.62-.93-.01 2.92.01 5.84-.02 8.75-.08 1.4-.54 2.79-1.35 3.94-1.31 1.92-3.58 3.17-5.91 3.21-1.43.08-2.86-.31-4.08-1.03-2.02-1.19-3.44-3.37-3.65-5.71-.02-.5-.03-1-.01-1.49.18-1.9 1.12-3.72 2.58-4.96 1.66-1.44 3.98-2.13 6.15-1.72.02 1.48-.04 2.96-.04 4.44-.99-.32-2.15-.23-3.02.37-.63.41-1.11 1.04-1.36 1.75-.21.51-.15 1.07-.14 1.61.24 1.64 1.82 3.02 3.5 2.87 1.12-.01 2.19-.66 2.77-1.61.19-.33.4-.67.41-1.06.1-1.79.06-3.57.07-5.36.01-4.03-.01-8.05.02-12.07z"/></svg>',
          'simple-icons:twitch': '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M11.571 4.714h1.715v5.143H11.57zm4.715 0H18v5.143h-1.714zM6 0L1.714 4.286v15.428h5.143V24l4.286-4.286h3.428L22.286 12V0zm14.571 11.143l-3.428 3.428h-3.429l-3 3v-3H6.857V1.714h13.714Z"/></svg>',
          'simple-icons:x': '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M18.901 1.153h3.68l-8.04 9.19L24 22.846h-7.406l-5.8-7.584-6.638 7.584H.474l8.6-9.83L0 1.154h7.594l5.243 6.932ZM17.61 20.644h2.039L6.486 3.24H4.298Z"/></svg>',
          'simple-icons:facebook': '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/></svg>',
          'simple-icons:instagram': '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 0C8.74 0 8.333.015 7.053.072 5.775.132 4.905.333 4.14.63c-.789.306-1.459.717-2.126 1.384S.935 3.35.63 4.14C.333 4.905.131 5.775.072 7.053.012 8.333 0 8.74 0 12s.015 3.667.072 4.947c.06 1.277.261 2.148.558 2.913.306.788.717 1.459 1.384 2.126.667.666 1.336 1.079 2.126 1.384.766.296 1.636.499 2.913.558C8.333 23.988 8.74 24 12 24s3.667-.015 4.947-.072c1.277-.06 2.148-.262 2.913-.558.788-.306 1.459-.718 2.126-1.384.666-.667 1.079-1.335 1.384-2.126.296-.765.499-1.636.558-2.913.06-1.28.072-1.687.072-4.947s-.015-3.667-.072-4.947c-.06-1.277-.262-2.149-.558-2.913-.306-.789-.718-1.459-1.384-2.126C21.319 1.347 20.651.935 19.86.63c-.765-.297-1.636-.499-2.913-.558C15.667.012 15.26 0 12 0zm0 2.16c3.203 0 3.585.016 4.85.071 1.17.055 1.805.249 2.227.415.562.217.96.477 1.382.896.419.42.679.819.896 1.381.164.422.36 1.057.413 2.227.057 1.266.07 1.646.07 4.85s-.015 3.585-.074 4.85c-.061 1.17-.256 1.805-.421 2.227-.224.562-.479.96-.899 1.382-.419.419-.824.679-1.38.896-.42.164-1.065.36-2.235.413-1.274.057-1.649.07-4.859.07-3.211 0-3.586-.015-4.859-.074-1.171-.061-1.816-.256-2.236-.421-.569-.224-.96-.479-1.379-.899-.421-.419-.69-.824-.9-1.38-.165-.42-.359-1.065-.42-2.235-.045-1.26-.061-1.649-.061-4.844 0-3.196.016-3.586.061-4.861.061-1.17.255-1.814.42-2.234.21-.57.479-.96.9-1.381.419-.419.81-.689 1.379-.898.42-.166 1.051-.361 2.221-.421 1.275-.045 1.65-.06 4.859-.06l.045.03zm0 3.678c-3.405 0-6.162 2.76-6.162 6.162 0 3.405 2.76 6.162 6.162 6.162 3.405 0 6.162-2.76 6.162-6.162 0-3.405-2.76-6.162-6.162-6.162zM12 16c-2.21 0-4-1.79-4-4s1.79-4 4-4 4 1.79 4 4-1.79 4-4 4zm7.846-10.405c0 .795-.646 1.44-1.44 1.44-.795 0-1.44-.646-1.44-1.44 0-.794.646-1.439 1.44-1.439.793-.001 1.44.645 1.44 1.439z"/></svg>',
          'simple-icons:threads': '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12.186 24h-.007c-3.581-.024-6.334-1.205-8.184-3.509C2.35 18.44 1.5 15.586 1.472 12.01v-.017c.03-3.579.879-6.43 2.525-8.482C5.845 1.205 8.6.024 12.18 0h.014c2.746.02 5.043.725 6.826 2.098 1.677 1.29 2.858 3.13 3.509 5.467l-2.04.569c-1.104-3.96-3.898-5.984-8.304-6.015-2.91.022-5.11.936-6.54 2.717C4.307 6.504 3.616 8.914 3.589 12c.027 3.086.718 5.496 2.057 7.164 1.43 1.781 3.631 2.695 6.54 2.717 2.623-.02 4.358-.631 5.8-2.045 1.647-1.613 1.618-3.593 1.09-4.798-.31-.71-.873-1.3-1.634-1.75-.192 1.352-.622 2.446-1.284 3.272-.886 1.102-2.14 1.704-3.73 1.79-1.202.065-2.361-.218-3.259-.801-1.063-.689-1.685-1.74-1.752-2.964-.065-1.19.408-2.285 1.33-3.082.88-.76 2.119-1.207 3.583-1.291a13.853 13.853 0 0 1 3.02.142c-.126-.742-.375-1.332-.75-1.757-.513-.586-1.308-.883-2.359-.883h-.033c-1.04 0-1.895.315-2.541.937-.645.62-1.033 1.524-1.153 2.684l-2.04-.204c.165-1.6.739-2.883 1.704-3.815 1.053-.998 2.455-1.505 4.17-1.505h.034c1.512 0 2.742.465 3.652 1.382.897.904 1.395 2.168 1.478 3.758.132.003.263.009.394.016 1.418.08 2.654.437 3.673 1.061 1.157.71 2.035 1.74 2.607 3.064.973 2.25.557 4.658-1.147 6.652-1.675 1.958-4.094 2.957-7.385 3.057a14.564 14.564 0 0 1-.298-.001zm1.535-11.04c-1.058-.036-2.007.179-2.748.622-.783.468-1.186 1.092-1.153 1.802.027.565.305 1.04.782 1.338.48.297 1.123.447 1.854.433 1.26-.024 2.246-.515 2.934-1.462.617-.85.972-2.11 1.046-3.733a11.851 11.851 0 0 0-2.715 0z"/></svg>',
          'simple-icons:reddit': '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 0C5.373 0 0 5.373 0 12s5.373 12 12 12 12-5.373 12-12S18.627 0 12 0zm4.431 11.07c-.268 0-.513.107-.692.281-.628-.462-1.494-.76-2.458-.798l.5-2.271 1.59.344c.02.554.471.996 1.031.996.571 0 1.034-.463 1.034-1.034s-.463-1.034-1.034-1.034c-.4 0-.747.227-.919.558l-1.776-.384c-.104-.022-.21.012-.276.09-.067.078-.089.184-.058.283l-.55 2.5c-.995.026-1.894.326-2.534.797-.179-.174-.424-.281-.693-.281-.888 0-1.302.992-.655 1.557-.037.178-.056.361-.056.548 0 1.795 2.091 3.256 4.667 3.256s4.667-1.461 4.667-3.256c0-.187-.019-.37-.056-.548.647-.565.232-1.557-.656-1.557z"/></svg>',
          'simple-icons:linkedin': '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/></svg>',
          'simple-icons:github': '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg>',
          'simple-icons:discord': '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M20.317 4.37a19.791 19.791 0 0 0-4.885-1.515.074.074 0 0 0-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 0 0-5.487 0 12.64 12.64 0 0 0-.617-1.25.077.077 0 0 0-.079-.037A19.736 19.736 0 0 0 3.677 4.37a.07.07 0 0 0-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 0 0 .031.057 19.9 19.9 0 0 0 5.993 3.03.078.078 0 0 0 .084-.028 14.09 14.09 0 0 0 1.226-1.994.076.076 0 0 0-.041-.106 13.107 13.107 0 0 1-1.872-.892.077.077 0 0 1-.008-.128 10.2 10.2 0 0 0 .372-.292.074.074 0 0 1 .077-.01c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 0 1 .078.01c.12.098.246.198.373.292a.077.077 0 0 1-.006.127 12.299 12.299 0 0 1-1.873.892.077.077 0 0 0-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 0 0 .084.028 19.839 19.839 0 0 0 6.002-3.03.077.077 0 0 0 .032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 0 0-.031-.03zM8.02 15.33c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.956-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.956 2.418-2.157 2.418zm7.975 0c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.955-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.946 2.418-2.157 2.418z"/></svg>',
        };
        
        return icons[iconName] || null;
      }
      
      // Create elements for each custom link
      container.innerHTML = '';
      
      customLinks.forEach(link => {
        const a = document.createElement('a');
        a.href = link.url;
        a.target = '_blank';
        a.rel = 'noopener noreferrer';
        a.setAttribute('aria-label', link.name);
        a.title = link.name;
        a.className = 'pwa-custom-link';
        
        // Set exact same styles as site links inline
        a.style.display = 'flex';
        a.style.alignItems = 'center';
        a.style.justifyContent = 'center';
        a.style.width = '48px';
        a.style.height = '48px';
        a.style.borderRadius = '8px';
        a.style.transition = 'all 0.2s';
        a.style.boxShadow = '0 2px 4px rgba(0, 0, 0, 0.3)';
        
        // Get computed background color from CSS variable
        const themeHeader = getComputedStyle(document.documentElement).getPropertyValue('--theme-header').trim() || '#1f2937';
        a.style.background = themeHeader;
        
        // Check if icon is provided and get SVG
        if (link.icon && link.icon.trim() !== '') {
          const svgMarkup = getSvgIcon(link.icon);
          
          if (svgMarkup) {
            // Create a container div for the SVG
            const iconContainer = document.createElement('div');
            iconContainer.innerHTML = svgMarkup;
            iconContainer.style.width = '28px';
            iconContainer.style.height = '28px';
            iconContainer.style.color = '#fff';
            iconContainer.style.display = 'flex';
            iconContainer.style.alignItems = 'center';
            iconContainer.style.justifyContent = 'center';
            
            // Style the SVG itself
            const svg = iconContainer.querySelector('svg');
            if (svg) {
              svg.style.width = '100%';
              svg.style.height = '100%';
            }
            
            a.appendChild(iconContainer);
          } else {
            // Icon name provided but not in our library, use initials
            const initialsEl = document.createElement('span');
            initialsEl.textContent = generateInitials(link.name);
            initialsEl.style.color = '#fff';
            initialsEl.style.fontSize = '16px';
            initialsEl.style.fontWeight = 'bold';
            initialsEl.style.letterSpacing = '1px';
            
            a.appendChild(initialsEl);
          }
        } else {
          // Create initials element
          const initialsEl = document.createElement('span');
          initialsEl.textContent = generateInitials(link.name);
          initialsEl.style.color = '#fff';
          initialsEl.style.fontSize = '16px';
          initialsEl.style.fontWeight = 'bold';
          initialsEl.style.letterSpacing = '1px';
          
          a.appendChild(initialsEl);
        }
        
        container.appendChild(a);
      });
      
      console.log('Custom links rendered:', container.children.length, 'elements');
      
    } catch (error) {
      console.error('Error loading custom PWA links:', error);
    }

    // After loading links, re-initialize bottom menu to check visibility
    setTimeout(() => {
      console.log('Calling initializeBottomMenu after custom links loaded');
      if (typeof initializeBottomMenu === 'function') {
        initializeBottomMenu();
      }
    }, 50);
  }

  // Bottom menu toggle functionality
  let menuClickHandler = null;
  let outsideClickHandler = null;

  function initializeBottomMenu() {
    const menuBtn = document.getElementById('bottom-menu-btn');
    const menuPopup = document.getElementById('menu-popup');
    const pwaMenu = document.getElementById('pwa-menu-items');
    const menuContainer = document.getElementById('bottom-menu-container');
    
    console.log('initializeBottomMenu called');
    
    if (!menuBtn || !menuPopup || !menuContainer) {
      console.error('Missing elements:', { menuBtn: !!menuBtn, menuPopup: !!menuPopup, menuContainer: !!menuContainer });
      return;
    }

    // Check if there are any menu items in the popup
    const menuLinks = menuPopup.querySelectorAll('a');
    const hasMenuItems = menuLinks.length > 0;

    // Check if there are any PWA links (site or custom)
    const pwaLinks = pwaMenu ? pwaMenu.querySelectorAll('.pwa-site-link, .pwa-custom-link') : [];
    const hasPwaLinks = pwaLinks.length > 0;

    console.log('Menu check:', { hasMenuItems, hasPwaLinks, menuLinksCount: menuLinks.length, pwaLinksCount: pwaLinks.length });

    // Hide menu button if there are no menu items AND no PWA links
    if (!hasMenuItems && !hasPwaLinks) {
      console.log('Hiding menu button - no items');
      menuContainer.style.display = 'none';
      return;
    } else {
      console.log('Showing menu button');
      menuContainer.style.display = 'grid';
    }

    // Apply custom menu position
    const savedPosition = localStorage.getItem('customMenuPosition') || 'bottom-center';
    menuContainer.className = '';
    menuContainer.classList.add(savedPosition);
    
    // Set initial state - hide PWA menu
    if (pwaMenu) {
      pwaMenu.style.display = 'none';
    }
    
    // Remove old handlers if they exist
    if (menuClickHandler) {
      menuBtn.removeEventListener('click', menuClickHandler);
    }
    if (outsideClickHandler) {
      document.removeEventListener('click', outsideClickHandler);
    }
    
    // Define and attach new click handler
    menuClickHandler = (e) => {
      e.stopPropagation();
      
      // Only show popup if there are actual menu items
      if (hasMenuItems) {
        menuPopup.classList.toggle('show');
      }
      
      // Always toggle PWA menu if it exists
      if (pwaMenu) {
        const currentDisplay = pwaMenu.style.display;
        if (currentDisplay === 'none' || currentDisplay === '') {
          pwaMenu.style.display = 'flex';
        } else {
          pwaMenu.style.display = 'none';
        }
      }
    };
    
    menuBtn.addEventListener('click', menuClickHandler);
    
    // Define and attach outside click handler
    outsideClickHandler = (e) => {
      const target = e.target;
      const isClickInsidePopup = menuPopup.contains(target);
      const isClickOnButton = menuBtn.contains(target);
      const isClickInsidePwaMenu = pwaMenu && pwaMenu.contains(target);
      
      if (!isClickInsidePopup && !isClickOnButton && !isClickInsidePwaMenu) {
        menuPopup.classList.remove('show');
        if (pwaMenu) {
          pwaMenu.style.display = 'none';
        }
      }
    };
    
    document.addEventListener('click', outsideClickHandler);
    
    // Close menu when clicking a regular menu link
    menuLinks.forEach(link => {
      link.addEventListener('click', () => {
        menuPopup.classList.remove('show');
        if (pwaMenu) {
          pwaMenu.style.display = 'none';
        }
      });
    });
  }

  // Load custom links on page load
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', loadCustomPwaLinks);
  } else {
    loadCustomPwaLinks();
  }
  
  // Reload custom links after navigation
  document.addEventListener('astro:after-swap', loadCustomPwaLinks);
  
  // Listen for custom event when links are updated in backup page
  window.addEventListener('customLinksUpdated', () => {
    loadCustomPwaLinks();
  });
  
  // Listen for storage changes to update links in real-time (for other tabs)
  window.addEventListener('storage', (e) => {
    if (e.key === 'customSocialLinks') {
      loadCustomPwaLinks();
    }
  });

  // Note: initializeBottomMenu is called by loadCustomPwaLinks after links are loaded
  // Also call it on navigation to apply position changes
  document.addEventListener('astro:after-swap', () => {
    setTimeout(() => {
      initializeBottomMenu();
    }, 100);
  });

  // Apply custom appearance colors
  function applyCustomAppearance() {
    const barColor = localStorage.getItem('customBarColor');
    const menuColor = localStorage.getItem('customMenuColor');
    
    // Get default color from CSS variable
    const defaultColor = getComputedStyle(document.documentElement).getPropertyValue('--theme-header').trim() || 'rgba(31, 41, 55, 1)';

    // Apply or reset bottom menu button background
    const bottomMenu = document.getElementById('bottom-menu-btn');
    if (bottomMenu) {
      bottomMenu.style.background = barColor || defaultColor;
    }

    // Apply or reset menu popup background
    const menuPopup = document.getElementById('menu-popup');
    if (menuPopup) {
      menuPopup.style.background = menuColor || defaultColor;
    }

    // Apply or reset PWA menu items background
    const pwaLinks = document.querySelectorAll('.pwa-site-link, .pwa-custom-link');
    pwaLinks.forEach((link) => {
      // @ts-ignore - querySelectorAll returns Element, but we know these are HTMLElements
      link.style.background = menuColor || defaultColor;
    });
  }

  // Apply appearance on load
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', applyCustomAppearance);
  } else {
    applyCustomAppearance();
  }

  // Listen for appearance updates
  window.addEventListener('appearanceUpdated', applyCustomAppearance);
  window.addEventListener('menuPositionUpdated', initializeBottomMenu);
  document.addEventListener('astro:after-swap', applyCustomAppearance);
</script>
