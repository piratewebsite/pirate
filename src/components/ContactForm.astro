---
import { getEntry } from 'astro:content';
import App from './App.astro';

interface Props {
  showTitle?: boolean;
  customTitle?: string;
  customDescription?: string;
  formName?: string;
}

const { showTitle = true, customTitle, customDescription, formName = 'form' } = Astro.props;

const formSettings = await getEntry('formSettings', 'index');

// Contact form field settings from form settings
const showName = formSettings?.data?.showName ?? true;
const showPhone = formSettings?.data?.showPhone ?? true;
const showUpload = formSettings?.data?.showUpload ?? true;
const showMessage = formSettings?.data?.showMessage ?? true;
const showExtraField = formSettings?.data?.showExtraField ?? false;
const extraFieldLabel = formSettings?.data?.extraFieldLabel ?? 'Extra Field';
const showMap = formSettings?.data?.showMap ?? true;
const showExtraField2 = formSettings?.data?.showExtraField2 ?? false;
const extraFieldLabel2 = formSettings?.data?.extraFieldLabel2 ?? 'Extra Field 2';
const content = (formSettings?.data?.formContent ?? '').replace(/\n/g, '<br>');

// Use custom title/description if provided, otherwise use defaults
const displayTitle = customTitle || 'Contact';
const displayDescription = customDescription;
---

<style>
  input, select {
    font-size: 16px !important;
  }

  input {
    font-size: 16px !important;
    padding: 10px;
    margin: 1vh auto;
    background: #000;
    border: 1px solid var(--theme-accent2) !important;
    color: #fff;
    padding: .4vh 2vw !important;
    height: 30px !important;
    outline: 1px solid var(--theme-accent2);
    border-radius: 5px;
    background: rgba(28, 23, 23, 0.8);
  }

  input, textarea {
    background-color: rgba(0, 0, 0, 0.8);
    color: #ddd;
    padding: .3vh .5vw;
    width: 100%;
  }

  input::placeholder, textarea::placeholder {
    color: rgb(253, 255, 253);
    font-size: clamp(.8rem, 1.5vw, 2.2rem) !important;
  }

  textarea {
    height: 30vh;
    padding: .4vh 2vw !important;
    outline: 1px solid var(--theme-accent2);
    border-radius: 5px;
    background: rgba(28, 23, 23, 0.8);
  }

  .stripe-button {
    background-color: var(--theme-header);
    color: #fff;
    border: none;
    padding: 10px 3vw;
    font-size: clamp(1.1rem, 1vw, 1.4rem);
    font-weight: bold;
    border-radius: 5px;
    cursor: pointer;
    display: flex;
    margin: 0 auto;
    transition: opacity 0.5s ease-in;
  }

  .contact-section {
    padding: 2rem 0;
  }

  .section-header {
    text-align: center;
    margin-bottom: 2rem;
  }

  .section-title {
    font-size: clamp(1.8rem, 4vw, 3rem);
    margin-bottom: 0.5rem;
  }

  .section-description {
    font-size: clamp(1rem, 2vw, 1.2rem);
    opacity: 0.8;
    margin-bottom: 1rem;
  }

  .hidden {
    display: none;
  }
</style>

<div class="contact-section">
  {showTitle && (
    <div class="section-header">
      <h2 class="section-title">{displayTitle}</h2>
      {displayDescription && (
        <p class="section-description">{displayDescription}</p>
      )}
      {!displayDescription && content && (
        <div class="section-description" set:html={content}></div>
      )}
    </div>
  )}
  
  <div class="flexbutt" style={`gap: 4vw; padding: 0 4%; ${showMap ? '' : 'justify-content: center;'}`}>
    <form
      class="flexcheek contact-form"
      name={formName}
      method="POST"
      data-netlify="true"
      data-netlify-honeypot="bot-field"
      style="justify-content: center; width: 100%; padding: 5vh 0 0 0; max-width: 500px; margin: 0 auto;"
    >
      <input type="hidden" name="form-name" value={formName} />
      <p class="hidden">
        <label>
          Don't fill this out if you're human: <input name="bot-field" />
        </label>
      </p>

      {showName && (
        <p>
          <label html-for="name" aria-label="Your Name">
            <input type="text" id="name" name="name" placeholder="Your Name" />
          </label>
        </p>
      )}

      <p>
        <label html-for="email" aria-label="Your Email">
          <input id="email" type="email" name="email" placeholder="Your@email.com" required />
        </label>
      </p>

      {showPhone && (
        <p>
          <label html-for="phone" aria-label="Your Phone">
            <input type="tel" id="phone" name="phone" placeholder="Your Phone" />
          </label>
        </p>
      )}

      {showExtraField && (
        <p>
          <label html-for="extraField" aria-label={extraFieldLabel}>
            <input type="text" id="extraField" name="extraField" placeholder={extraFieldLabel} />
          </label>
        </p>
      )}

      {showExtraField2 && (
        <p>
          <label html-for="extraField2" aria-label={extraFieldLabel2}>
            <input type="text" id="extraField2" name="extraField2" placeholder={extraFieldLabel2} />
          </label>
        </p>
      )}

      {showMessage && (
        <p>
          <label html-for="message" aria-label="Your Message">
            <textarea id="message" name="message" placeholder="Message"></textarea>
          </label>
        </p>
      )}

      {showUpload && (
        <p>
          <label html-for="attachment1" style={{ padding: '0', color: '', display: 'flex', width: '100%', fontSize: '90%', gap: '15px', justifyContent: 'center', alignItems: 'center' }}>
            <input class="file-input button" type="file" id="attachment1" name="attachment1" />
            ZIP files preferred
          </label>
        </p>
      )}

      <div class="" style="display: grid; place-items: center; margin: 1vh auto; color: #fff; width: 100%; border: 0px solid var(--theme-accent2);">
        <button class="button stripe-button" style="margin: 0" type="submit">
          Send Message
        </button>
      </div>
    </form>

    {showMap && (
      <div class="flexcheek" style="justify-content: center; padding: 0">
        <App />
      </div>
    )}
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const form = document.querySelector('.contact-form') as HTMLFormElement;
    if (!form) return;

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const formData = new FormData(form);
      const button = form.querySelector('button[type="submit"]') as HTMLButtonElement;
      const originalText = button?.textContent || '';
      
      if (button) {
        button.disabled = true;
        button.textContent = 'Sending...';
      }

      try {
        // Debug: Log what we're sending
        console.log('Form submission started');
        console.log('Form name:', formData.get('form-name'));
        console.log('All form fields:', Array.from(formData.keys()));
        
        // For forms with file uploads, we need to use FormData directly
        // But we need to encode it properly for Netlify
        const hasFile = Array.from(formData.values()).some(value => value instanceof File && value.size > 0);
        
        let response;
        if (hasFile) {
          // Use multipart/form-data for file uploads
          response = await fetch('/', {
            method: 'POST',
            body: formData,
          });
        } else {
          // Use application/x-www-form-urlencoded for regular forms
          const params = new URLSearchParams();
          for (const [key, value] of formData.entries()) {
            if (typeof value === 'string') {
              params.append(key, value);
            }
          }
          response = await fetch('/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: params.toString(),
          });
        }

        if (response.ok) {
          window.location.href = '/thanks/';
        } else {
          throw new Error('Form submission failed');
        }
      } catch (error) {
        console.error('Form submission error:', error);
        alert('There was an error submitting the form. Please try again.');
        if (button) {
          button.disabled = false;
          button.textContent = originalText;
        }
      }
    });
  });
</script>
