---
import Base from '../layouts/Base.astro';

const title = 'Data Backup';
const description = 'Backup and restore your settings, favorites, and preferences.';
---

<Base title={title} description={description}>
  <main class="main-content">
    <div class="membership-container">
      <!-- Header -->
      <div class="membership-header">
        <h1>User Data Management</h1>
        <p>Backup and restore your settings, favorites, and preferences.</p>
      </div>

      <!-- Premium Status Check -->
      <div id="premium-check" class="current-status">
        <div class="flex items-center justify-center">
          <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-accent"></div>
          <span class="ml-2">Checking status...</span>
        </div>
      </div>

      <!-- Backup/Restore Interface (hidden until premium status confirmed) -->
      <div id="backup-interface" class="hidden">
        
        <!-- Data Overview -->
        <div class="pricing-grid mb-8">
          <div class="plan-card">
            <h2 class="text-xl font-bold mb-4 flex items-center justify-center">
              <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 24 24">
                <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
              </svg>
              Current Data
            </h2>
            <div id="data-overview" class="space-y-3 text-sm">
              <!-- Will be populated by JavaScript -->
            </div>
          </div>

          <div class="plan-card">
            <h2 class="text-xl font-bold mb-4 flex items-center justify-center">
              <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 24 24">
                <path d="M13 6a3 3 0 11-6 0 3 3 0 616 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3z"/>
              </svg>
              Last Backup
            </h2>
            <div id="backup-info" class="text-sm">
              <p>No backup found</p>
            </div>
          </div>
        </div>

        <!-- Custom Social Links Manager -->
        <div class="plan-card mb-6">
          <h2 class="text-2xl font-bold mb-4 flex items-center justify-center">
            <svg class="w-6 h-6 mr-2" fill="currentColor" viewBox="0 0 24 24">
              <path d="M18 2h-3a5 5 0 00-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 011-1h3z"/>
            </svg>
            My Social Links
          </h2>
          <p class="mb-4 opacity-80">
            Create and manage your personal list of social media links. These will be saved to your browser and included in backups.
          </p>

          <!-- Add New Link Form -->
          <div class="bg-gray-700/50 p-4 rounded-lg mb-4" id="add-link-form">
            <h3 class="font-bold mb-3">Add New Link</h3>
            <div class="space-y-3">
              <div>
                <label class="block text-sm mb-1">Friendly Name</label>
                <input type="text" id="link-name" placeholder="e.g., My YouTube" class="w-full p-2 rounded bg-gray-800 border border-gray-600">
              </div>
              <div>
                <label class="block text-sm mb-1">URL</label>
                <input type="url" id="link-url" placeholder="https://youtube.com/@username" class="w-full p-2 rounded bg-gray-800 border border-gray-600">
              </div>
              <div>
                <label class="block text-sm mb-1">Icon</label>
                <select id="link-icon" class="w-full p-2 rounded bg-gray-800 border border-gray-600">
                  <option value="bi:youtube">YouTube</option>
                  <option value="bi:tiktok">TikTok</option>
                  <option value="bi:twitch">Twitch</option>
                  <option value="simple-icons:bluesky">Bluesky</option>
                  <option value="bi:twitter-x">X/Twitter</option>
                  <option value="bi:threads">Threads</option>
                  <option value="bi:facebook">Facebook</option>
                  <option value="bi:instagram">Instagram</option>
                  <option value="bi:reddit">Reddit</option>
                  <option value="bi:discord">Discord</option>
                  <option value="bi:spotify">Spotify</option>
                  <option value="mdi:soundcloud">SoundCloud</option>
                  <option value="mdi:patreon">Patreon</option>
                  <option value="bi:linkedin">LinkedIn</option>
                  <option value="bi:github">GitHub</option>
                  <option value="bi:mastodon">Mastodon</option>
                  <option value="bi:pinterest">Pinterest</option>
                  <option value="bi:snapchat">Snapchat</option>
                  <option value="bi:whatsapp">WhatsApp</option>
                  <option value="game-icons:pirate-flag">Pirate</option>
                </select>
              </div>
              <button id="add-link-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition-colors w-full">
                + Add Link
              </button>
            </div>
          </div>

          <!-- Current Links List -->
          <div id="social-links-list" class="space-y-2">
            <!-- Will be populated by JavaScript -->
          </div>
        </div>

        <!-- Backup Section -->
        <div class="plan-card mb-6">
          <h2 class="text-2xl font-bold mb-4 flex items-center justify-center">
            <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"/>
            </svg>
            Create Backup
          </h2>
          <p class="mb-4 opacity-80">
            Download a backup file containing all your settings, favorites, and preferences.
          </p>
          <button id="backup-btn" class="btn-primary">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3M3 17V7a2 2 0 012-2h6l2 2h6a2 2 0 012 2v10a2 2 0 01-2 2H5a2 2 0 01-2-2z"/>
            </svg>
            Download Backup
          </button>
        </div>

        <!-- Restore Section -->
        <div class="plan-card mb-6">
          <h2 class="text-2xl font-bold mb-4 flex items-center justify-center">
            <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
            </svg>
            Restore from Backup
          </h2>
          <p class="mb-4 opacity-80">
            Upload a backup file to restore your settings. This will replace all current data.
          </p>
          
          <div class="border-2 border-dashed border-gray-600 rounded-lg p-6 text-center mb-4" id="drop-zone">
            <svg class="mx-auto h-8 w-8 text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
            </svg>
            <p class="text-gray-400">Drag and drop your backup file here, or</p>
            <input type="file" id="restore-input" accept=".json" class="hidden">
            <button id="browse-btn" class="mt-2 bg-gray-700 hover:bg-gray-600 text-white py-2 px-4 rounded-lg transition-colors">
              Browse Files
            </button>
          </div>
          
          <div id="restore-preview" class="hidden bg-gray-700 p-4 rounded-lg mb-4">
            <h3 class="font-bold text-accent mb-2">Backup Preview:</h3>
            <div id="restore-details" class="text-sm text-gray-300"></div>
          </div>
          
          <button id="restore-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center" disabled style="margin:0 auto;">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
            </svg>
            Restore Data
          </button>
        </div>

        <!-- Clear Data Section -->
        <div class="bg-red-900/20 border border-red-600/30 p-6 rounded-lg" style="max-width: 400px; margin:0 auto; display:grid; place-self: center; justify-content: center;">
          <h2 class="font-bold mb-2 text-red-400 flex items-center">
            <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
            </svg>
            Clear All Data
          </h2>
          <p class="text-gray-300 mb-4">
            <strong>Warning:</strong> This will permanently delete all your favorites, subscriptions, and settings.
          </p>
          <button id="clear-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">
            Clear All Data
          </button>
        </div>
      </div>

      <!-- Non-Premium Notice -->
      <div id="non-premium-notice" class="hidden text-center bg-gray-800 p-8 rounded-lg border border-gray-700">
        <svg class="mx-auto h-12 w-12 text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
        </svg>
        <h2 class="text-2xl font-bold text-gray-300 mb-4">Premium Feature</h2>
        <p class="text-gray-400 mb-6">
          Data backup and restore is available for premium members only.
        </p>
        <a href="/features" class="bg-accent hover:bg-accent/80 text-gray-300 font-bold py-3 px-6 rounded-lg transition-colors inline-flex items-center">
          <svg class="w-5 h-5 mr-2" fill="#fff" viewBox="0 0 20 20">
            <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
          </svg>
          Upgrade to Premium
        </a>
      </div>
    </div>
  </main>
</Base>

<script>
  class BackupManager {
    constructor() {
      this.initializeEventListeners();
      this.checkPremiumStatus();
    }

    // Define all localStorage keys that should be backed up
    getBackupKeys() {
      return {
        memberData: [
          'memberFavorites',
          'memberChannels', 
          'channelOrder'
        ],
        membership: [
          'membershipCode',
          'membershipStatus',
          'membershipCacheTime'
        ],
        preferences: [
          'video-preferences',
          'videoPreference_muted',
          'memberFavorites-collapsed'
        ],
        customData: [
          'customSocialLinks'
        ],
        uiState: [] // Will be populated dynamically for channel-collapsed-* keys
      };
    }

    async checkPremiumStatus() {
      const statusElement = document.getElementById('premium-check');
      const interfaceElement = document.getElementById('backup-interface');
      const noticeElement = document.getElementById('non-premium-notice');

      try {
        // Wait for global membership utils to be available
        let attempts = 0;
        while (!globalThis.checkUnifiedMembershipStatus && attempts < 50) {
          await new Promise(resolve => setTimeout(resolve, 100));
          attempts++;
        }

        if (!globalThis.checkUnifiedMembershipStatus) {
          throw new Error('Membership utilities not available');
        }

        // Check membership status using the same method as other components
        const result = await globalThis.checkUnifiedMembershipStatus();

        if (result.isValid && result.tier !== 'free') {
          // Premium user - show interface
          statusElement?.classList.add('hidden');
          interfaceElement?.classList.remove('hidden');
          this.updateDataOverview();
        } else {
          throw new Error('Not premium member');
        }
      } catch (error) {
        console.log('Premium check failed:', error);
        // Not premium or error - show upgrade notice
        statusElement?.classList.add('hidden');
        noticeElement?.classList.remove('hidden');
      }
    }

    updateDataOverview() {
      const overview = document.getElementById('data-overview');
      if (!overview) return;
      
      const keys = this.getBackupKeys();
      
      let html = '';
      let totalItems = 0;

      // Check member data
      const favorites = JSON.parse(localStorage.getItem('memberFavorites') || '[]');
      const channels = JSON.parse(localStorage.getItem('memberChannels') || '[]');
      const channelOrder = JSON.parse(localStorage.getItem('channelOrder') || '[]');
      
      html += `<div class="flex justify-between"><span>Favorite Videos:</span><span class="text-accent">${favorites.length}</span></div>`;
      html += `<div class="flex justify-between"><span>Subscribed Channels:</span><span class="text-accent">${channels.length}</span></div>`;
      html += `<div class="flex justify-between"><span>Channel Order:</span><span class="text-accent">${channelOrder.length > 0 ? 'Set' : 'Default'}</span></div>`;
      
      // Check preferences
      const hasVideoPrefs = localStorage.getItem('video-preferences') || localStorage.getItem('videoPreference_muted');
      html += `<div class="flex justify-between"><span>Video Preferences:</span><span class="text-accent">${hasVideoPrefs ? 'Set' : 'Default'}</span></div>`;
      
      // Check UI state
      const uiKeys = Object.keys(localStorage).filter(key => 
        key.startsWith('channel-collapsed-') || key === 'memberFavorites-collapsed'
      );
      html += `<div class="flex justify-between"><span>UI Preferences:</span><span class="text-accent">${uiKeys.length} items</span></div>`;
      
      // Check custom social links
      const socialLinks = JSON.parse(localStorage.getItem('customSocialLinks') || '[]');
      html += `<div class="flex justify-between"><span>Custom Social Links:</span><span class="text-accent">${socialLinks.length}</span></div>`;
      
      // Check membership
      // const membershipCode = localStorage.getItem('membershipCode');
      // html += `<div class="flex justify-between"><span>Membership:</span><span class="text-accent">${membershipCode ? 'Active' : 'None'}</span></div>`;

      overview.innerHTML = html;

      // Update backup info
      this.updateBackupInfo();
    }

    updateBackupInfo() {
      const backupInfo = document.getElementById('backup-info');
      if (!backupInfo) return;
      
      const lastBackup = localStorage.getItem('lastBackupDate');
      
      if (lastBackup) {
        const date = new Date(parseInt(lastBackup));
        backupInfo.innerHTML = `
          <p class="text-green-400">‚úì Last backup: ${date.toLocaleDateString()} at ${date.toLocaleTimeString()}</p>
          <p class="text-xs text-gray-400 mt-1">Regular backups help protect your data</p>
        `;
      } else {
        backupInfo.innerHTML = `
          <p class="text-yellow-400">‚ö† No backup found</p>
          <p class="text-xs text-gray-400 mt-1">Create your first backup to protect your data</p>
        `;
      }
    }

    createBackup() {
      try {
        const keys = this.getBackupKeys();
        const backup = {
          version: '1.0',
          timestamp: Date.now(),
          date: new Date().toISOString(),
          data: {}
        };

        // Backup member data
        keys.memberData.forEach(key => {
          const value = localStorage.getItem(key);
          if (value) {
            backup.data[key] = JSON.parse(value);
          }
        });

        // Backup membership info
        keys.membership.forEach(key => {
          const value = localStorage.getItem(key);
          if (value) {
            backup.data[key] = key.endsWith('Status') ? JSON.parse(value) : value;
          }
        });

        // Backup preferences
        keys.preferences.forEach(key => {
          const value = localStorage.getItem(key);
          if (value) {
            backup.data[key] = key.includes('preferences') ? JSON.parse(value) : value;
          }
        });

        // Backup custom data
        keys.customData.forEach(key => {
          const value = localStorage.getItem(key);
          if (value) {
            backup.data[key] = JSON.parse(value);
          }
        });

        // Backup dynamic UI state
        Object.keys(localStorage).forEach(key => {
          if (key.startsWith('channel-collapsed-') || key.startsWith('viewMode-')) {
            backup.data[key] = localStorage.getItem(key);
          }
        });

        // Create and download file
        const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `privacyvideo-backup-${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        // Update last backup time
        localStorage.setItem('lastBackupDate', Date.now().toString());
        this.updateBackupInfo();

        // Show success message
        this.showMessage('Backup created successfully!', 'success');
      } catch (error) {
        console.error('Backup creation failed:', error);
        this.showMessage('Failed to create backup. Please try again.', 'error');
      }
    }

    async restoreBackup(file) {
      try {
        const text = await file.text();
        const backup = JSON.parse(text);

        // Validate backup format
        if (!backup.version || !backup.data) {
          throw new Error('Invalid backup file format');
        }

        // Show confirmation dialog
        const confirmMessage = `This will restore data from ${new Date(backup.timestamp).toLocaleDateString()}.\n\nThis will replace ALL current data including:\n‚Ä¢ ${Object.keys(backup.data).length} settings\n‚Ä¢ All favorites and subscriptions\n‚Ä¢ All preferences\n\nAre you sure you want to continue?`;
        
        if (!confirm(confirmMessage)) {
          return;
        }

        // Clear existing data first
        this.clearAllData(false);

        // Restore data
        Object.entries(backup.data).forEach(([key, value]) => {
          if (value !== undefined) {
            if (typeof value === 'object') {
              localStorage.setItem(key, JSON.stringify(value));
            } else {
              localStorage.setItem(key, String(value));
            }
          }
        });

        this.showMessage('Data restored successfully! Refreshing page...', 'success');
        
        // Refresh page after a short delay
        setTimeout(() => {
          window.location.reload();
        }, 2000);

      } catch (error) {
        console.error('Restore failed:', error);
        this.showMessage('Failed to restore backup. Please check the file and try again.', 'error');
      }
    }

    clearAllData(showConfirmation = true) {
      if (showConfirmation) {
        const confirmMessage = 'This will permanently delete ALL your data including:\n\n‚Ä¢ All favorite videos\n‚Ä¢ All channel subscriptions\n‚Ä¢ All preferences and settings\n‚Ä¢ Membership information\n\nThis action cannot be undone. Are you sure?';
        
        if (!confirm(confirmMessage)) {
          return;
        }
      }

      // Get all keys to clear
      const keys = this.getBackupKeys();
      const allKeys = [
        ...keys.memberData,
        ...keys.membership,
        ...keys.preferences,
        ...keys.customData
      ];

      // Add dynamic keys
      Object.keys(localStorage).forEach(key => {
        if (key.startsWith('channel-collapsed-') || key.startsWith('viewMode-') || key === 'lastBackupDate') {
          allKeys.push(key);
        }
      });

      // Clear all keys
      allKeys.forEach(key => {
        localStorage.removeItem(key);
      });

      if (showConfirmation) {
        this.showMessage('All data cleared successfully!', 'success');
        this.updateDataOverview();
      }
    }

    showMessage(message, type = 'info') {
      // Create toast message
      const toast = document.createElement('div');
      toast.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg max-w-sm ${
        type === 'success' ? 'bg-green-600 text-white' :
        type === 'error' ? 'bg-red-600 text-white' :
        'bg-blue-600 text-white'
      }`;
      toast.textContent = message;
      
      document.body.appendChild(toast);
      
      // Remove after 3 seconds
      setTimeout(() => {
        if (document.body.contains(toast)) {
          document.body.removeChild(toast);
        }
      }, 3000);
    }

    // Social Links Management
    getSocialLinks() {
      const links = localStorage.getItem('customSocialLinks');
      return links ? JSON.parse(links) : [];
    }

    saveSocialLinks(links) {
      localStorage.setItem('customSocialLinks', JSON.stringify(links));
      this.renderSocialLinks();
      this.updateDataOverview();
    }

    addSocialLink(name, url, icon) {
      if (!name || !url) {
        this.showMessage('Please fill in all required fields', 'error');
        return;
      }

      const links = this.getSocialLinks();
      const newLink = {
        id: Date.now(),
        name: name.trim(),
        url: url.trim(),
        icon: icon,
        order: links.length
      };

      links.push(newLink);
      this.saveSocialLinks(links);
      this.showMessage('Link added successfully!', 'success');

      // Clear form
      const nameInput = document.getElementById('link-name') as HTMLInputElement;
      const urlInput = document.getElementById('link-url') as HTMLInputElement;
      const iconSelect = document.getElementById('link-icon') as HTMLSelectElement;
      if (nameInput) nameInput.value = '';
      if (urlInput) urlInput.value = '';
      if (iconSelect) iconSelect.selectedIndex = 0;
    }

    deleteSocialLink(id) {
      if (!confirm('Are you sure you want to delete this link?')) {
        return;
      }

      const links = this.getSocialLinks();
      const filtered = links.filter(link => link.id !== id);
      this.saveSocialLinks(filtered);
      this.showMessage('Link deleted successfully!', 'success');
    }

    moveSocialLink(id, direction) {
      const links = this.getSocialLinks();
      const index = links.findIndex(link => link.id === id);
      
      if (index === -1) return;
      
      const newIndex = direction === 'up' ? index - 1 : index + 1;
      
      if (newIndex < 0 || newIndex >= links.length) return;
      
      // Swap
      [links[index], links[newIndex]] = [links[newIndex], links[index]];
      
      // Update orders
      links.forEach((link, idx) => link.order = idx);
      
      this.saveSocialLinks(links);
    }

    renderSocialLinks() {
      const container = document.getElementById('social-links-list');
      if (!container) return;

      const links = this.getSocialLinks();

      if (links.length === 0) {
        container.innerHTML = '<p class="text-gray-400 text-center py-4">No links added yet. Add your first link above!</p>';
        return;
      }

      container.innerHTML = links.map((link, index) => `
        <div class="flex items-center gap-2 bg-gray-700/30 p-3 rounded-lg">
          <div class="flex-1 flex items-center gap-3">
            <div class="text-2xl">üì±</div>
            <div class="flex-1">
              <div class="font-bold">${this.escapeHtml(link.name)}</div>
              <div class="text-sm text-gray-400">${this.escapeHtml(link.url)}</div>
              <div class="text-xs text-gray-500">Icon: ${link.icon}</div>
            </div>
          </div>
          <div class="flex gap-1">
            ${index > 0 ? `<button onclick="backupManager.moveSocialLink(${link.id}, 'up')" class="p-2 bg-gray-600 hover:bg-gray-500 rounded" title="Move up">‚Üë</button>` : ''}
            ${index < links.length - 1 ? `<button onclick="backupManager.moveSocialLink(${link.id}, 'down')" class="p-2 bg-gray-600 hover:bg-gray-500 rounded" title="Move down">‚Üì</button>` : ''}
            <a href="${this.escapeHtml(link.url)}" target="_blank" class="p-2 bg-blue-600 hover:bg-blue-500 rounded" title="Visit">üîó</a>
            <button onclick="backupManager.deleteSocialLink(${link.id})" class="p-2 bg-red-600 hover:bg-red-500 rounded" title="Delete">üóëÔ∏è</button>
          </div>
        </div>
      `).join('');
    }

    escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    initializeEventListeners() {
      // Backup button
      document.getElementById('backup-btn')?.addEventListener('click', () => {
        this.createBackup();
      });

      // File input
      const fileInput = document.getElementById('restore-input') as HTMLInputElement;
      const browseBtn = document.getElementById('browse-btn');
      const dropZone = document.getElementById('drop-zone');
      const restoreBtn = document.getElementById('restore-btn') as HTMLButtonElement;

      browseBtn?.addEventListener('click', () => {
        fileInput?.click();
      });

      fileInput?.addEventListener('change', (e) => {
        const target = e.target as HTMLInputElement;
        const file = target?.files?.[0];
        if (file) {
          this.previewBackup(file);
        }
      });

      // Drag and drop
      dropZone?.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.classList.add('border-accent');
      });

      dropZone?.addEventListener('dragleave', (e) => {
        e.preventDefault();
        dropZone.classList.remove('border-accent');
      });

      dropZone?.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('border-accent');
        const file = e.dataTransfer?.files?.[0];
        if (file && file.type === 'application/json') {
          this.previewBackup(file);
        }
      });

      // Restore button
      restoreBtn?.addEventListener('click', () => {
        const file = fileInput?.files?.[0];
        if (file) {
          this.restoreBackup(file);
        }
      });

      // Clear button
      document.getElementById('clear-btn')?.addEventListener('click', () => {
        this.clearAllData();
      });

      // Social Links - Add button
      document.getElementById('add-link-btn')?.addEventListener('click', () => {
        const name = (document.getElementById('link-name') as HTMLInputElement)?.value;
        const url = (document.getElementById('link-url') as HTMLInputElement)?.value;
        const icon = (document.getElementById('link-icon') as HTMLSelectElement)?.value;
        this.addSocialLink(name, url, icon);
      });

      // Social Links - Enter key support
      const linkInputs = ['link-name', 'link-url'];
      linkInputs.forEach(id => {
        document.getElementById(id)?.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            document.getElementById('add-link-btn')?.click();
          }
        });
      });

      // Render social links on initialization
      this.renderSocialLinks();
    }

    async previewBackup(file) {
      try {
        const text = await file.text();
        const backup = JSON.parse(text);
        
        const preview = document.getElementById('restore-preview');
        const details = document.getElementById('restore-details');
        const restoreBtn = document.getElementById('restore-btn') as HTMLButtonElement;

        if (!backup.version || !backup.data) {
          throw new Error('Invalid backup format');
        }

        const dataCount = Object.keys(backup.data).length;
        const date = new Date(backup.timestamp).toLocaleDateString();
        
        if (details) {
          details.innerHTML = `
            <p><strong>Backup Date:</strong> ${date}</p>
            <p><strong>Version:</strong> ${backup.version}</p>
            <p><strong>Data Items:</strong> ${dataCount}</p>
            <p class="text-xs text-gray-400 mt-2">File: ${file.name}</p>
          `;
        }

        preview?.classList.remove('hidden');
        if (restoreBtn) {
          restoreBtn.disabled = false;
          restoreBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        }

      } catch (error) {
        this.showMessage('Invalid backup file format', 'error');
      }
    }
  }

  // Declare global type
  declare global {
    interface Window {
      backupManager: BackupManager;
    }
  }

  // Initialize when page loads and make it globally accessible
  let backupManager: BackupManager;
  document.addEventListener('DOMContentLoaded', () => {
    backupManager = new BackupManager();
    window.backupManager = backupManager;
  });
</script>

<style>
  .main-content {
    min-height: calc(100vh - 120px);
    background:#333; 
    color: white;
  }
  
  #drop-zone.border-accent {
    border-color: #ffd700;
    background-color: rgba(255, 215, 0, 0.1);
  }

  /* Membership page styling */
  .membership-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 2rem;
  }

  .membership-header {
    text-align: center;
    margin-bottom: 3rem;
  }

  .membership-header h1 {
  font-size: 2.5rem;
  font-weight: 900;
  margin-bottom: 1rem;
  background: linear-gradient(45deg,#ef4444,#f97316,#eab308);
    background-clip: border-box;
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  line-height: 1.1;
  }





  .membership-header p {
    font-size: 1.25rem;
    color: #d1d5db;
    max-width: 600px;
    margin: 0 auto;
  }

  .current-status {
    text-align: center;
    padding: 2rem;
    margin-bottom: 2rem;
    background: linear-gradient(135deg, rgba(255, 215, 0, 0.1), rgba(255, 255, 255, 0.05));
    border: 1px solid rgba(255, 215, 0, 0.2);
    border-radius: 1rem;
  }

  .pricing-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
    gap: 2rem;
    margin-bottom: 2rem;
  }

  .plan-card {
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 1rem;
    padding: 2rem;
    text-align: center;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
  }

  .plan-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
    transition: left 0.5s ease;
  }

  .plan-card:hover::before {
    left: 100%;
  }

  .plan-card:hover {
    transform: translateY(-5px);
    border-color: rgba(255, 215, 0, 0.3);
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
  }

  .btn-primary {
    background: linear-gradient(135deg, #ffd700, #ffed4e);
    color: #000;
    font-weight: bold;
    padding: 0.75rem 1.5rem;
    border-radius: 0.5rem;
    border: none;
    cursor: pointer;
    transition: all 0.3s ease;
    display: inline-flex;
    align-items: center;
    text-decoration: none;
  }

  .btn-primary:hover {
    background: linear-gradient(135deg, #ffed4e, #ffd700);
    transform: translateY(-2px);
    box-shadow: 0 10px 20px rgba(255, 215, 0, 0.3);
  }

  /* Dark mode support */
  [data-theme="dark"] .membership-header h1 {
    background: linear-gradient(135deg, #fff, #ffd700);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  [data-theme="light"] .membership-header h1 {
    background: linear-gradient(135deg, #1f2937, #ffd700);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  [data-theme="light"] .membership-header p {
    color: #6b7280;
  }

  [data-theme="light"] .plan-card {
    background: linear-gradient(135deg, rgba(0, 0, 0, 0.05), rgba(0, 0, 0, 0.02));
    border: 1px solid rgba(0, 0, 0, 0.1);
  }

  [data-theme="light"] .current-status {
    background: linear-gradient(135deg, rgba(255, 215, 0, 0.1), rgba(0, 0, 0, 0.02));
    border: 1px solid rgba(255, 215, 0, 0.2);
  }
</style>
